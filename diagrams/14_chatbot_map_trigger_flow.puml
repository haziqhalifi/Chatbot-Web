@startuml Chatbot to ArcGIS Map Trigger Flow
!theme plain
title User Interaction with Chatbot to Trigger ArcGIS Map Display

actor User
participant "ChatBox\n(Frontend)" as ChatBox
participant "useChat Hook\n(Frontend)" as UseChat
participant "Backend API\n(/chat/generate)" as Backend
participant "OpenAI Assistant\nService" as OpenAI
participant "OpenAI API\n(Assistant)" as OpenAIAPI
participant "Map Controller\n(Frontend)" as MapController
participant "ArcGIS\nJavaScript API" as ArcGIS
database "ArcGIS\nFeature Server" as FeatureServer

== User Sends Location-Based Query ==

User -> ChatBox: Types message\n"Show me flood areas in Kuala Lumpur"
activate ChatBox

ChatBox -> UseChat: sendMessage(message)
activate UseChat

UseChat -> Backend: POST /chat/generate\n{session_id, prompt, rag_enabled}
activate Backend
note right
  Headers:
  - Authorization: Bearer <token>
  - X-API-Key: <api_key>
end note

== Backend Processes with OpenAI Assistant ==

Backend -> Backend: Verify session & user
Backend -> Backend: Get AI provider\n(default: "openai")

Backend -> OpenAI: send_message(thread_id, prompt)
activate OpenAI
note right
  OpenAI Assistant is configured
  with MAP_TOOLS (15 functions):
  - Search, Zoom, Pan
  - ToggleLayer, DrawBuffer
  - FindNearestIn, etc.
end note

OpenAI -> OpenAIAPI: Create message in thread
activate OpenAIAPI

OpenAI -> OpenAIAPI: Run assistant with MAP_TOOLS
OpenAIAPI -> OpenAIAPI: AI analyzes user query\n"flood areas in Kuala Lumpur"

== AI Decides to Call Map Functions ==

OpenAIAPI -> OpenAIAPI: Decide to use map tools
note right
  AI determines:
  1. User wants location → Search
  2. User wants flood data → ToggleLayer
end note

OpenAIAPI --> OpenAI: Run status: "requires_action"\nwith tool_calls
deactivate OpenAIAPI

== Backend Captures Map Commands ==

OpenAI -> OpenAI: Extract tool calls
note right
  Tool Call 1:
  - Function: "Search"
  - Arguments: {place: "Kuala Lumpur"}
  
  Tool Call 2:
  - Function: "ToggleLayer"
  - Arguments: {layer: "flood", visible: true}
end note

OpenAI -> OpenAI: Store as map_commands array

OpenAI -> OpenAIAPI: Submit tool outputs\n(acknowledge execution)
activate OpenAIAPI

OpenAIAPI -> OpenAIAPI: Continue assistant run

OpenAIAPI --> OpenAI: Assistant text response\n"I'll show you flood areas in KL"
deactivate OpenAIAPI

OpenAI --> Backend: Return response + map_commands
deactivate OpenAI

note left of Backend
  Response structure:
  {
    "response": "I'll show you flood areas...",
    "map_commands": [
      {function: "Search", arguments: {...}},
      {function: "ToggleLayer", arguments: {...}}
    ],
    "provider": "openai",
    "duration": 2.5
  }
end note

== Backend Returns to Frontend ==

Backend -> Backend: Save user message to DB
Backend -> Backend: Save bot response to DB

Backend --> UseChat: HTTP 200\n{user_message, bot_message, ai_response}
deactivate Backend

== Frontend Dispatches Map Commands ==

UseChat -> UseChat: Add messages to chat UI
UseChat -> UseChat: Check if map_commands exist

alt Map Commands Present
    UseChat -> UseChat: Dispatch custom event
    note right
      window.dispatchEvent(
        new CustomEvent('mapCommand', {
          detail: { commands: map_commands }
        })
      )
    end note
    
    UseChat --> ChatBox: Return response
    deactivate UseChat
    
    ChatBox -> ChatBox: Listen for 'mapCommand' event
    
    == Execute Map Commands ==
    
    ChatBox -> MapController: executeCommands(commands)
    activate MapController
    
    loop For each command
        alt Command: Search
            MapController -> ArcGIS: Geocoding service\naddressToLocations("Kuala Lumpur")
            activate ArcGIS
            
            ArcGIS --> MapController: Return coordinates
            
            MapController -> ArcGIS: view.goTo({center, zoom: 13})
            MapController -> ArcGIS: Add marker graphic
            
            ArcGIS -> ArcGIS: Map zooms to location
            ArcGIS -> ArcGIS: Display marker
            deactivate ArcGIS
            
        else Command: ToggleLayer
            MapController -> Backend: GET /map/endpoints/flood
            activate Backend
            
            Backend --> MapController: Return layer URL
            deactivate Backend
            
            MapController -> MapController: Create FeatureLayer(url)
            note right
              new FeatureLayer({
                url: "https://services7.arcgis.com/.../Flood_Prone_Area",
                title: "Flood Prone Area",
                visible: true
              })
            end note
            
            MapController -> ArcGIS: view.map.add(layer)
            activate ArcGIS
            
            ArcGIS -> FeatureServer: Fetch flood data
            activate FeatureServer
            
            FeatureServer --> ArcGIS: Return GIS features
            deactivate FeatureServer
            
            ArcGIS -> ArcGIS: Render flood areas on map
            deactivate ArcGIS
        end
    end
    
    MapController --> ChatBox: Execution results
    deactivate MapController
    
    ChatBox -> ChatBox: Log command results
    
else No Map Commands
    UseChat --> ChatBox: Return response only
    deactivate UseChat
end

ChatBox --> User: Display chat response\n+ Updated map view
deactivate ChatBox

== User Sees Result ==

User -> User: Sees text response in chat
User -> User: Sees map zoomed to Kuala Lumpur
User -> User: Sees flood-prone areas highlighted

note over User
  User can now:
  - Continue conversation
  - Interact with map (zoom, pan)
  - Ask follow-up questions
  - Request other layers/locations
end note

@enduml
