@startuml AI Response Generation
!theme plain
title AI Response Generation Activity Diagram

start

:Receive user prompt;

:Validate API key (if direct API call);

:Check RAG enabled setting;

if (RAG enabled?) then (yes)
    :Initialize RAG system;
    :Load embeddings.pkl;
    :Search knowledge base;
    :Retrieve relevant documents;
    :Score document relevance;
    if (Relevant documents found?) then (yes)
        :Enhance prompt with context;
        :Format enhanced prompt;
    else (no)
        :Use original prompt;
    endif
else (no)
    :Use original prompt;
endif

:Send prompt to AI model;

:AI model processes request;

if (Response generated successfully?) then (yes)
    :Extract response content;
    :Format response;
    :Log interaction;
    :Return formatted response;
else (no)
    :Log error;
    :Return error message;
endif

:Update user credit usage;

stop
@enduml
